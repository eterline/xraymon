syntax = "proto3";

package xraymon.commands;

import "google/protobuf/duration.proto";

option go_package = "github.com/eterline/xraymon/internal/interface/grpc/commands";

// ============

service CoreManagmentService {
    rpc CoreStatus(CoreStatusRequest) returns (CoreStatusResponse);
    rpc CoreRestart(CoreRestartRequest) returns (CoreRestartResponse);
    rpc GetConfig(GetConfigRequest) returns (GetConfigResponse);
    rpc UploadConfig(UploadConfigRequest) returns (UploadConfigResponse);
}

service JournalProvider {
    rpc ConnectionJournal(ConnectionJournalRequest) returns (stream ConnectionMeta);
    rpc NetworkStats(NetworkStatsRequest) returns (NetworkStatsResponse);
}

// ============

message ConnectionIO {
    uint64 bytes_rx         = 1;
    uint64 bytes_tx         = 2;
    uint64 bytes_per_sec_rx = 3;
    uint64 bytes_per_sec_tx = 4;
}

enum ConnectionType {
    INBOUND  = 0;
    OUTBOUND = 1;
    USER     = 2;
}

message StatsMeta {
    ConnectionType type  = 1;
    string         alias = 2;
    ConnectionIO   io    = 3;
}

message NetworkStatsResponse {
    repeated StatsMeta stats = 1;
}

message NetworkStatsRequest {}

message ConnectionJournalRequest {
    uint64 last = 1;
}

enum NetType {
    HTTP = 0;
    TCP  = 1;
    UDP  = 2;
}

message ConnectionMeta {
    string  client   = 1;
    string  server   = 2;
    NetType proto    = 3;
    string  inbound  = 4;
    string  outbound = 5;
    string  user     = 6;
}

// =======

message CoreStatusRequest {}

message CoreStatusResponse {
    bool                        working         = 1;
    string                      last_log        = 2;
    google.protobuf.Duration    working_time    = 3;
}

// =======

message CoreRestartRequest {}

message CoreRestartResponse {}

// =======

message GetConfigRequest {}

message GetConfigResponse {
    string data = 1;
}

message UploadConfigRequest {
    string   data        = 1;
    bool     restart_core = 2;
}

message UploadConfigResponse {}